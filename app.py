import streamlit as st
from modules.auth import check_auth, login_screen, logout
from modules.styles import apply_custom_styles
from modules.db.view import show_order_cards
from modules.db.create import show_create_order
from modules.admin_module import show_admin_panel

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ú–ê–Ñ –±—É—Ç–∏ –ø–µ—Ä—à–∏–º –≤–∏–∫–ª–∏–∫–æ–º st.
st.set_page_config(page_title="GETMANN Pro", layout="wide", page_icon="üè≠")

apply_custom_styles()

if not check_auth():
    login_screen()
    st.stop()

# –†–µ–Ω–¥–µ—Ä –º–µ–Ω—é
menu = st.sidebar.radio("–ù–∞–≤—ñ–≥–∞—Ü—ñ—è", ["üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è", "üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å"])

if menu == "üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è":
    st.title("üì¶ –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º–∏")
    t_view, t_create = st.tabs(["üîé –ñ—É—Ä–Ω–∞–ª", "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏"])
    with t_view:
        show_order_cards()
    with t_create:
        show_create_order()
elif menu == "üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å":
    show_admin_panel()
)

# 2. –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è CSS —Å—Ç–∏–ª—ñ–≤
# –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤–∞—à—ñ –∫–∞—Å—Ç–æ–º–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏–∑–∞–π–Ω—É –∫–∞—Ä—Ç–æ–∫
try:
    apply_custom_styles()
except Exception as e:
    st.error(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤: {e}")

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –∑ –≤–∞—à–æ–≥–æ –º–æ–¥—É–ª—é auth.py
if not check_auth():
    login_screen()
    st.stop()  # –ó—É–ø–∏–Ω—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∏–∂—á–µ, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ —É–≤—ñ–π—à–æ–≤

# --- –Ø–ö–©–û –ê–í–¢–û–†–ò–ó–û–í–ê–ù–û, –í–ò–ö–û–ù–£–Ñ–¢–¨–°–Ø –ö–û–î –ù–ò–ñ–ß–ï ---

# 4. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Å–µ—Å—ñ—ó
user = st.session_state.auth
role = user.get('role', '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')
user_display = user.get('login') or user.get('email', '–ù–µ–≤—ñ–¥–æ–º–∏–π')

# 5. –ë—ñ—á–Ω–∞ –ø–∞–Ω–µ–ª—å (Sidebar)
with st.sidebar:
    st.title("üè≠ GETMANN Pro")
    st.markdown(f"**–í—ñ—Ç–∞—î–º–æ,** `{user_display}`")
    st.markdown(f"**–†–æ–ª—å:** `{role}`")
    st.divider()
    
    # –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é
    menu_options = ["üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è"]
    
    # –î–æ—Å—Ç—É–ø –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ –ª–∏—à–µ –¥–ª—è –ê–¥–º—ñ–Ω—ñ–≤
    if role in ["–ê–¥–º—ñ–Ω", "–°—É–ø–µ—Ä –ê–¥–º—ñ–Ω"]:
        menu_options.append("üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å")
    
    menu = st.radio("–ù–∞–≤—ñ–≥–∞—Ü—ñ—è", menu_options)
    
    st.divider()
    
    # –ö–Ω–æ–ø–∫–∞ –≤–∏—Ö–æ–¥—É (–≤–∏–∫–ª–∏–∫–∞—î –≤–∞—à—É —Ñ—É–Ω–∫—Ü—ñ—é logout –∑ –∫—É–∫–∞–º–∏)
    if st.button("üö™ –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏", use_container_width=True):
        logout()
    
    st.sidebar.caption("v3.1 Stable Build (2026)")

# 6. –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
if menu == "üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è":
    st.title("üì¶ –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º–∏")
    
    # –†–æ–∑–ø–æ–¥—ñ–ª—è—î–º–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –Ω–∞ –≤–∫–ª–∞–¥–∫–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ Duplicate ID
    tab_view, tab_create = st.tabs(["üîé –ñ—É—Ä–Ω–∞–ª –∑–∞–º–æ–≤–ª–µ–Ω—å", "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ"])
    
    with tab_view:
        # –ú–æ–¥—É–ª—å –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞ –∂–∏–≤–æ–≥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–æ–∫
        show_order_cards()
        
    with tab_create:
        # –ú–æ–¥—É–ª—å —Ñ–æ—Ä–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        show_create_order()

elif menu == "üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å":
    # –ú–æ–¥—É–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –±–∞–∑–æ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    show_admin_panel()

# 7. –§—É—Ç–µ—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
# –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–±–æ —Å—Ç–∞—Ç—É—Å –∑'—î–¥–Ω–∞–Ω–Ω—è

