import streamlit as st
import pandas as pd
from modules.drive_tools import load_csv, save_csv, ORDERS_CSV_ID

def show_orders_journal():
    st.subheader("üìã –ñ—É—Ä–Ω–∞–ª –∑–∞–º–æ–≤–ª–µ–Ω—å")

    # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    df = load_csv(ORDERS_CSV_ID)
    
    # –í–∏–∑–Ω–∞—á–∞—î–º–æ –µ—Ç–∞–ª–æ–Ω–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    columns_list = ["–î–∞—Ç–∞", "–ó–∞–º–æ–≤–Ω–∏–∫", "–¢–æ–≤–∞—Ä", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "–¶—ñ–Ω–∞ –∑–∞ –æ–¥.", "–°—É–º–∞", "–°—Ç–∞—Ç—É—Å", "–ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞"]

    # –ê–í–¢–û-–ú–ï–¢–û–î: –Ø–∫—â–æ —Ñ–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π, —Å—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–µ–∑ –∑–∞–ø–∏—Ç–∞–Ω—å
    if df.empty or len(df.columns) < 2:
        st.info("—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∂—É—Ä–Ω–∞–ª—É...")
        df = pd.DataFrame(columns=columns_list)
        save_csv(ORDERS_CSV_ID, df)
        st.rerun()

    # –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏ (—è–∫—â–æ –≤–∏ –≤–∏—Ä—ñ—à–∏—Ç–µ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É)
    for col in columns_list:
        if col not in df.columns:
            df[col] = ""

    # –ü—Ä–∏–≤–µ–¥–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
    df['–ö—ñ–ª—å–∫—ñ—Å—Ç—å'] = pd.to_numeric(df['–ö—ñ–ª—å–∫—ñ—Å—Ç—å'], errors='coerce').fillna(0)
    df['–¶—ñ–Ω–∞ –∑–∞ –æ–¥.'] = pd.to_numeric(df['–¶—ñ–Ω–∞ –∑–∞ –æ–¥.'], errors='coerce').fillna(0)
    df['–°—É–º–∞'] = pd.to_numeric(df['–°—Éma'], errors='coerce').fillna(df['–ö—ñ–ª—å–∫—ñ—Å—Ç—å'] * df['–¶—ñ–Ω–∞ –∑–∞ –æ–¥.'])

    # 2. –ü–æ—à—É–∫ (–ø—Ä–∞—Ü—é—î –ø–æ –≤—Å—ñ—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö –æ–¥–Ω–æ—á–∞—Å–Ω–æ)
    search = st.text_input("üîé –ü–æ—à—É–∫ —É –∂—É—Ä–Ω–∞–ª—ñ", placeholder="–í–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫—ñ –¥–∞–Ω—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó...")
    if search:
        df_display = df[df.astype(str).apply(lambda x: x.str.contains(search, case=False)).any(axis=1)]
    else:
        df_display = df

    # 3. –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–∞–±–ª–∏—Ü—ñ
    st.write("üìù *–ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É '–ó–±–µ—Ä–µ–≥—Ç–∏' –ø—ñ—Å–ª—è –∑–º—ñ–Ω.*")
    
    edited_df = st.data_editor(
        df_display,
        column_config={
            "–î–∞—Ç–∞": st.column_config.TextColumn("–î–∞—Ç–∞"),
            "–ö—ñ–ª—å–∫—ñ—Å—Ç—å": st.column_config.NumberColumn("–ö-—Å—Ç—å", format="%d"),
            "–¶—ñ–Ω–∞ –∑–∞ –æ–¥.": st.column_config.NumberColumn("–¶—ñ–Ω–∞, ‚Ç¥", format="%.2f"),
            "–°—É–º–∞": st.column_config.NumberColumn("–í—Å—å–æ–≥–æ, ‚Ç¥", format="%.2f", help="–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ"),
            "–°—Ç–∞—Ç—É—Å": st.column_config.SelectboxColumn(
                "–°—Ç–∞—Ç—É—Å", 
                options=["–ù–æ–≤–∏–π", "–í —Ä–æ–±–æ—Ç—ñ", "–í–∏–∫–æ–Ω–∞–Ω–æ", "–û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏", "–°–∫–∞—Å–æ–≤–∞–Ω–æ"]
            ),
            "–ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞": st.column_config.TextColumn("–ö–æ–º–µ–Ω—Ç–∞—Ä", width="large")
        },
        use_container_width=True,
        hide_index=True,
        num_rows="dynamic", # –î–æ–∑–≤–æ–ª—è—î –¥–æ–¥–∞–≤–∞—Ç–∏ (+) —Ç–∞ –≤–∏–¥–∞–ª—è—Ç–∏ —Ä—è–¥–∫–∏
        key="orders_editor_v3"
    )

    # 4. –õ–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    if st.button("üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏", type="primary"):
        # –Ø–∫—â–æ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –ø–æ—à—É–∫, –Ω–∞–º —Ç—Ä–µ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω–∏–π DF –∑–º—ñ–Ω–µ–Ω–∏–º–∏ —Ä—è–¥–∫–∞–º–∏
        if search:
            # –û–Ω–æ–≤–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π DF –¥–∞–Ω–∏–º–∏ –∑ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ–≥–æ —Ç–∞ –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ–≥–æ DF
            df.update(edited_df)
            final_df = df
        else:
            final_df = edited_df

        # –§—ñ–Ω–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Å—É–º–∏ –¥–ª—è –≤—Å—ñ—Ö —Ä—è–¥–∫—ñ–≤
        final_df['–°—É–º–∞'] = final_df['–ö—ñ–ª—å–∫—ñ—Å—Ç—å'] * final_df['–¶—ñ–Ω–∞ –∑–∞ –æ–¥.']
        
        if save_csv(ORDERS_CSV_ID, final_df):
            st.success("‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ Google Drive!")
            st.rerun()

    # –ö–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –ø—ñ–¥ —Ç–∞–±–ª–∏—Ü–µ—é
    if not final_df.empty:
        total_sum = final_df['–°—É–º–∞'].sum()
        st.write(f"üìä **–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å —É —Ç–∞–±–ª–∏—Ü—ñ:** {total_sum:,.2f} ‚Ç¥")
